name: Scripts release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version to pin into scripts (e.g. 0.5.0)"
        required: true
        type: string
      make_latest:
        description: "Mark this release as latest"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Prepare scripts bundle
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          STAGE_ROOT="artifacts/scripts-${VERSION}"

          mkdir -p "$STAGE_ROOT/scripts"
          python .github/scripts/generate_install_wrappers.py --version "$VERSION" --output-dir "$STAGE_ROOT/scripts"

          builders=(yara suricata wazuh-agent)
          for b in "${builders[@]}"; do
            mkdir -p "$STAGE_ROOT/builders/$b"
            cp "builders/$b/scripts/install.sh" "$STAGE_ROOT/builders/$b/install.sh"
            cp "builders/$b/scripts/uninstall.sh" "$STAGE_ROOT/builders/$b/uninstall.sh"
            for meta in version.txt release.txt package_revision.txt; do
              if [ -f "builders/$b/$meta" ]; then
                cp "builders/$b/$meta" "$STAGE_ROOT/builders/$b/$meta"
              fi
            done
          done

          mkdir -p artifacts
          tar -czf "artifacts/scripts-${VERSION}.tar.gz" -C artifacts "scripts-${VERSION}"
          ls -l artifacts

      - name: Publish scripts release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: scripts-v${{ inputs.version }}
          name: Scripts ${{ inputs.version }}
          make_latest: ${{ inputs.make_latest }}
          draft: false
          prerelease: false
          files: artifacts/scripts-${{ inputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
