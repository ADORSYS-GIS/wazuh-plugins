name: Scripts release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version to pin into scripts (e.g. 0.5.0)"
        required: true
        type: string
      make_latest:
        description: "Mark this release as latest"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Prepare scripts bundle
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          STAGE_ROOT="artifacts/scripts-${VERSION}"
          mkdir -p "$STAGE_ROOT"

          python .github/scripts/generate_install_wrappers.py --version "$VERSION" --output-dir "$STAGE_ROOT"

          builders=(yara suricata wazuh-agent)
          for b in "${builders[@]}"; do
            cp "builders/$b/scripts/install.sh" "$STAGE_ROOT/${b}-install.sh"
            cp "builders/$b/scripts/uninstall.sh" "$STAGE_ROOT/${b}-uninstall.sh"
          done

          echo "STAGE_ROOT=$STAGE_ROOT" >> "$GITHUB_ENV"
          ls -l "$STAGE_ROOT"

      - name: Publish scripts release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: scripts-v${{ inputs.version }}
          name: Scripts ${{ inputs.version }}
          make_latest: ${{ inputs.make_latest }}
          draft: false
          prerelease: false
          files: |
            ${{ env.STAGE_ROOT }}/install.sh
            ${{ env.STAGE_ROOT }}/uninstall.sh
            ${{ env.STAGE_ROOT }}/yara-install.sh
            ${{ env.STAGE_ROOT }}/yara-uninstall.sh
            ${{ env.STAGE_ROOT }}/suricata-install.sh
            ${{ env.STAGE_ROOT }}/suricata-uninstall.sh
            ${{ env.STAGE_ROOT }}/wazuh-agent-install.sh
            ${{ env.STAGE_ROOT }}/wazuh-agent-uninstall.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
